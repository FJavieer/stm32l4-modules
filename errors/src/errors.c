/******************************************************************************
 *	error.c								      *
 *	2018/dec/13							      *
 ******************************************************************************/


/******************************************************************************
 ******* headers **************************************************************
 ******************************************************************************/
/* Standard C ----------------------------------------------------------------*/
	#include <stdbool.h>
	#include <stdint.h>

/* Drivers -------------------------------------------------------------------*/
	#include "stm32l4xx_hal.h"

/* libalx --------------------------------------------------------------------*/
	#include "alx_mask.h"

/* STM32L4 modules -----------------------------------------------------------*/
		/* delay_us_init(), delay_us() */
	#include "delay.h"
		/* led_init(), led_set(), led_stop() */
	#include "led.h"

	#include "errors.h"


/******************************************************************************
 ******* macros ***************************************************************
 ******************************************************************************/
	# define	ERROR_BIT_LEN			(1000000u)
	# define	ERROR_LONG_PULSE_LEN_US		(800000u)
	# define	ERROR_SHORT_PULSE_LEN_US	(200000u)
	# define	ERROR_LOOP_FOREVER		(true)


/******************************************************************************
 ******* enums ****************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* structs **************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* variables ************************************************************
 ******************************************************************************/
/* Global --------------------------------------------------------------------*/
	uint32_t	error;
/* Static --------------------------------------------------------------------*/


/******************************************************************************
 ******* static functions (prototypes) ****************************************
 ******************************************************************************/
static	void	flash_error	(void);
static	void	flash_long	(void);
static	void	flash_short	(void);


/******************************************************************************
 ******* global functions *****************************************************
 ******************************************************************************/
	/**
	 * @brief	Handle error
	 *		Displays the error value by flashing a led from MSB
	 *		to LSB.  A long flash is a 1 and a short flash is a 0.
	 *		After displaying the value, it resets 'error'.
	 * @return	None
	 */
void	error_handle	(void)
{
	int	i;
#if (!ERROR_LOOP_FOREVER)
	int	j;
#endif

#if (ERROR_LOOP_FOREVER)
	while (true) {
#else
	for (j = 0; j < 3; j++) {
#endif
		for (i = 0; i < 10; i++) {
			led_set();
			delay_us(50000u);
			led_reset();
			delay_us(50000u);
		}

		flash_error();
	}

	error	= 0;
}


/******************************************************************************
 ******* static functions (definitions) ***************************************
 ******************************************************************************/
static	void	flash_error	(void)
{
	int	i;
	bool	bit;

	for (i = 31; i >= 0; i--) {
		bit	= error & alx_maskgen_u32(i);

		if (bit) {
			flash_long();
		} else {
			flash_short();
		}
	}
}

static	void	flash_long	(void)
{
	led_set();
	delay_us(ERROR_LONG_PULSE_LEN_US);

	led_reset();
	delay_us(ERROR_BIT_LEN - ERROR_LONG_PULSE_LEN_US);
}

static	void	flash_short	(void)
{
	led_set();
	delay_us(ERROR_SHORT_PULSE_LEN_US);

	led_reset();
	delay_us(ERROR_BIT_LEN - ERROR_SHORT_PULSE_LEN_US);
}


/******************************************************************************
 ******* end of file **********************************************************
 ******************************************************************************/
